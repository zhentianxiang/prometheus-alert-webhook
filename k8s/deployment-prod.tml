apiVersion: v1
kind: ConfigMap
metadata:
  name: {{.IMAGE_NAME}}-config
  namespace: {{.PROJECT_NAME}}
data:
  config.yaml: |
    # Prometheus Webhook é…ç½®æ–‡ä»¶
    # ç”¨äºæ¥æ”¶ Prometheus Alertmanager çš„å‘Šè­¦é€šçŸ¥å¹¶è½¬å‘åˆ°é£ä¹¦ã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç¾¤èŠ

    # æœåŠ¡å™¨é…ç½®
    server:
      # æœåŠ¡ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ä¸º 8080
      port: "8080"
      # è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œæ”¯æŒæ ¼å¼å¦‚: 30s, 1m, 1h
      timeout: 30s

    # æ—¥å¿—é…ç½®
    logging:
      # æ—¥å¿—çº§åˆ«: debug, info, warn, error
      level: "info"
      # æ—¥å¿—æ ¼å¼: json, text
      format: "json"

    # æ¨¡æ¿é…ç½®
    template:
      # æ—¶åŒºè®¾ç½®ï¼Œç”¨äºæ—¶é—´æ ¼å¼åŒ–
      timezone: "Asia/Shanghai"

    # Webhook æä¾›å•†è®¾ç½®
    webhooks:
      feishu:
        # å¯ç”¨æ­¤ webhook
        enable: true
        # é£ä¹¦ webhook URL
        webhook_url: "https://open.feishu.cn/open-apis/bot/v2/hook/a06d5b36-a9d2-4408-a1dc-5ba73810b20c"
        timeout: 30s
        retry_count: 3
        template: "templates/feishu.tmpl"
      dingding:
        enable: false
        webhook_url: "https://oapi.dingtalk.com/robot/send?access_token=3b270c49f421b589749d4ce9dea8b9eafda7cc08d94bbefc98e34051b7f017c5"
        secret: "SECbd1123d0b434ac3dbd4f1f118f6148bafa392090699e87eb02012953bf2aeeed" # é’‰é’‰é€šå¸¸éœ€è¦ä¸€ä¸ªå¯†é’¥è¿›è¡Œç­¾å
        timeout: 10s
        retry_count: 3
        template: "templates/dingding.tmpl"
      weixin:
        enable: false
        webhook_url: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=5f7c6145-47f9-441c-a020-f92b543a3aad"
        timeout: 10s
        retry_count: 3
        template: "templates/weixin.tmpl"
  feishu.tmpl: |
    {{define "feishu_message"}}[
        {{- range $i, $alert := .alerts -}}
        {{if $i}},{{end}}
        {
            "msg_type": "interactive",
            "card": {
                "config": {
                    "wide_screen_mode": true,
                    "enable_forward": true
                },
                "header": {
                    "template": "{{if eq $alert.Status `resolved`}}green{{else}}red{{end}}",
                    "title": {
                        "tag": "plain_text",
                        "content": "PrometheusAlert"
                    }
                },
                "elements": [
                    {
                        "tag": "div",
                        "text": { "tag": "lark_md", "content": "{{if eq $alert.Status `resolved`}}âœ… Kubernetes é›†ç¾¤æ¢å¤é€šçŸ¥ âœ…{{else}}ğŸš¨ Kubernetes é›†ç¾¤å‘Šè­¦é€šçŸ¥ ğŸš¨{{end}}" }
                    },
                    {
                        "tag": "div",
                        "text": { "tag": "lark_md", "content": "ğŸ”” **å‘Šè­¦åç§°:** {{$alert.Labels.alertname}}\nğŸš© **å‘Šè­¦çº§åˆ«:** {{$alert.Labels.severity}}" }
                    },
                    { "tag": "hr" },
                    {
                        "tag": "div",
                        "text": { "tag": "lark_md", "content": "ğŸ”¥ **å‘Šè­¦çŠ¶æ€:** {{$alert.Status}}\nğŸ•’ **å¼€å§‹æ—¶é—´:** {{getCSTtime $alert.StartsAt}}{{if eq $alert.Status `resolved`}}\nğŸ•’ **ç»“æŸæ—¶é—´:** {{getCSTtime $alert.EndsAt}}{{end}}" }
                    },
                    { "tag": "hr" },
                    {
                        "tag": "div",
                        "text": { "tag": "lark_md", "content": "**ğŸ“Œ å‘Šè­¦è¯¦æƒ…**\n{{- range $alert.Fields}}\n- {{.key}} {{.value}}{{- end}}" }
                    },
                    { "tag": "hr" },
                    {
                        "tag": "div",
                        "text": { "tag": "lark_md", "content": "**ğŸ“ å‘Šè­¦æè¿°**\n{{- if $alert.Annotations.summary}}**æ‘˜è¦:** {{$alert.Annotations.summary}}\n{{end}}{{- if $alert.Annotations.message}}**è¯¦æƒ…:** {{$alert.Annotations.message}}{{- end}}{{if not (or $alert.Annotations.summary $alert.Annotations.message)}}æš‚æ— æè¿°{{end}}" }
                    },
                    { "tag": "hr" },
                    {
                        "tag": "div",
                        "text": { "tag": "lark_md", "content": "**ğŸ“… å‘Šè­¦æ—¶é—´çº¿**\n- **é¦–æ¬¡è§¦å‘:** {{getCSTtime $alert.StartsAt}}" }
                    },
                    { "tag": "hr" },
                    {
                        "tag": "div",
                        "text": { "tag": "lark_md", "content": "**ğŸ“ è”ç³»æ”¯æŒ**\nå¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³» Kubernetes è¿ç»´å›¢é˜Ÿæˆ–æŸ¥çœ‹ç›¸å…³æ–‡æ¡£ã€‚" }
                    },
                    { "tag": "hr" },
                    {
                        "tag": "div",
                        "text": { "tag": "lark_md", "content": "{{if eq $alert.Status `resolved`}}**âœ… å‘Šè­¦å·²æ¢å¤ï¼Œè¯·ç¡®è®¤ä¸šåŠ¡æ­£å¸¸è¿è¡Œï¼**{{else}}**ğŸ”” è¯·åŠæ—¶å¤„ç†ï¼Œé¿å…å½±å“ä¸šåŠ¡æ­£å¸¸è¿è¡Œï¼**{{end}}" }
                    },
                    {
                        "tag": "note",
                        "elements": [
                            {
                                "tag": "plain_text",
                                "content": "PrometheusAlert"
                            }
                        ]
                    }
                ]
            }
        }
        {{- end -}}
    ]
    {{end}}
  dingding.tmpl: |
    {{ define "dingding_message" }}
    {
        "msgtype": "markdown",
        "markdown": {
            "title": "{{ with .alerts }}{{ (index . 0).Labels.alertname }}{{ else }}Prometheus å‘Šè­¦{{ end }}",
            "text": "{{ range $i, $alert := .alerts }}{{if eq .Status `resolved`}}### âœ… <font color=\"#008000\">ã€å‘Šè­¦æ¢å¤ã€‘</font>\n\n{{else}}### ğŸš¨ <font color=\"#FF0000\">ã€å‘Šè­¦è§¦å‘ã€‘</font>\n\n{{end}}**å‘Šè­¦åç§°:** {{ .Labels.alertname }}\n\n**å‘Šè­¦çº§åˆ«:** {{ .Labels.severity }}\n\n**çŠ¶æ€:** {{ .Status }}\n\n**å‘Šè­¦è¯¦æƒ…:**\n\n{{ range .Fields }}{{ .key }} {{ .value }}\n\n{{ end }}**æ‘˜è¦:** {{ .Annotations.summary }}\n\n**è¯¦æƒ…æè¿°:** {{ if .Annotations.description }}{{ .Annotations.description }}{{ else }}{{ .Annotations.message }}{{ end }}\n\n**æ—¶é—´ä¿¡æ¯:**\nå¼€å§‹æ—¶é—´: {{ .StartsAt | getCSTtime }}{{if eq .Status `resolved`}}\nç»“æŸæ—¶é—´: {{ .EndsAt | getCSTtime }}{{end}}{{ if gt (len $.alerts) 1 }}{{ if lt $i (sub (len $.alerts) 1) }}\n\n---\n\n{{ end }}{{ end }}{{ end }}"
        },
        "at": {
            "isAtAll": false
        }
    }
    {{ end }} 
  weixin.tmpl: |
    {{ define "weixin_message" }}
    {
        "msgtype": "markdown",
        "markdown": {
            "content": "{{ range $i, $alert := .alerts }}{{if eq .Status `resolved`}}### âœ… <font color=\"info\">ã€å‘Šè­¦æ¢å¤ã€‘</font>\n{{else}}### ğŸ”¥ <font color=\"warning\">ã€å‘Šè­¦è§¦å‘ã€‘</font>\n{{end}}**å‘Šè­¦åç§°:** {{ .Labels.alertname }}\n**å‘Šè­¦çº§åˆ«:** <font color=\"comment\">{{ .Labels.severity }}</font>\n**çŠ¶æ€:** {{ .Status }}\n\n**å‘Šè­¦è¯¦æƒ…:**\n{{ range .Fields }}- {{ .key }} {{ .value }}\n{{ end }}\n**æ‘˜è¦:** {{ .Annotations.summary }}\n**è¯¦æƒ…æè¿°:** {{ if .Annotations.description }}{{ .Annotations.description }}{{ else }}{{ .Annotations.message }}{{ end }}\n\n**æ—¶é—´ä¿¡æ¯:**\nå¼€å§‹æ—¶é—´: {{ .StartsAt | getCSTtime }}{{if eq .Status `resolved`}}\nç»“æŸæ—¶é—´: {{ .EndsAt | getCSTtime }}{{end}}{{ if gt (len $.alerts) 1 }}{{ if lt $i (sub (len $.alerts) 1) }}\n---\n{{ end }}{{ end }}{{ end }}"
        }
    }
    {{ end }}
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: {{.IMAGE_NAME}}
  namespace: {{.PROJECT_NAME}}
  labels:
    k8s-app: {{.IMAGE_NAME}}
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: {{.IMAGE_NAME}}
  template:
    metadata:
      labels:
        k8s-app: {{.IMAGE_NAME}}
        logging: 'true'
    spec:
      containers:
        - name: {{.IMAGE_NAME}}
          image: "{{.HARBOR_ADDRESS}}/{{.PROJECT_NAME}}/{{.IMAGE_NAME}}:{{.TAG_NAME}}"
          imagePullPolicy: Always
          ports:
            - name: http-0
              containerPort: 8080
              protocol: TCP
          env:
            - name: TZ
              value: "Asia/Shanghai"  # è®¾ç½®æ—¶åŒºï¼Œé¿å…æ—¥å¿—æ—¶é—´é”™ä¹±
          resources:
            limits:
              cpu: '0.5'
              memory: 1Gi
            requests:
              cpu: 200m
              memory: 512Mi
          livenessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 15
            timeoutSeconds: 5
            periodSeconds: 10
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 10
            timeoutSeconds: 1
            periodSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          volumeMounts:
            - name: config
              mountPath: /app/config/config.yaml
              subPath: config.yaml
            - name: config
              mountPath: /app/templates/feishu.tmpl
              subPath: feishu.tmpl
            - name: config
              mountPath: /app/templates/dingding.tmpl
              subPath: dingding.tmpl
            - name: config
              mountPath: /app/templates/weixin.tmpl
              subPath: weixin.tmpl
      volumes:
        - name: config
          configMap:
            name: {{.IMAGE_NAME}}-config
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: {{.IMAGE_NAME}}
  namespace: {{.PROJECT_NAME}}
  labels:
    k8s-app: {{.IMAGE_NAME}}
spec:
  ports:
  - name: http
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    k8s-app: {{.IMAGE_NAME}}
  type: NodePort
